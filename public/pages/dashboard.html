<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سامانه دانشگاه</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap');

    body {
      margin: 0;
      font-family: 'Vazirmatn', sans-serif;
      direction: rtl;
      background-color: #f4f6f9;
    }

    /* Navbar */
    .navbar {
      background-color: #1a237e;
      color: white;
      padding: 6px 1.2rem;
      text-align: right;
      font-size: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .avatar-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-right: 20px;
    }

    #avatarImg {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #fff;
      cursor: pointer;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 50px;
      left: 0;
      background-color: white;
      color: black;
      border-radius: 6px;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 120px;
      overflow: hidden;
      font-size: 14px;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px 15px;
      text-decoration: none;
      color: black;
      transition: background 0.3s;
    }

    .dropdown-menu a:hover {
      background-color: #f0f0f0;
    }


    /* Layout */
    .container {
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: #2e3b55;
      color: white;
      height: 100vh;
      padding-top: 20px;
      position: sticky;
      top: 0;
    }

    .sidebar a {
      display: block;
      padding: 15px 25px;
      color: white;
      text-decoration: none;
      font-size: 16px;
      transition: background 0.2s;
    }

    .sidebar a:hover {
      background-color: #3f4d70;
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 30px;
      padding-bottom: 0;
    }

    #announcementsCard {
      border: 2px solid red;
    }

    .card {
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    h2 {
      margin-bottom: 16px;
      border-bottom: 2px solid #012137;
      padding-bottom: 8px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: "Vazirmatn", sans-serif;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #218838;
    }
    
    input {
      border: none;
      border-radius: 12px;
      padding: 8px;
      font-family: "Vazirmatn", sans-serif;
      font-size: 1.1rem;
      box-shadow: 0px 0px 10px #000;
      margin: 10px;
    }

    .login-btn {
      margin-top: 8px;
      font-size: 1rem;
    }

    .profile {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .profile-image-wrapper {
      position: relative;
      width: 200px;
      height: 200px;
      display: flex;
    }

    #profile-image {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #eee;
    }

    .add-icon {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: #007bff;
      color: #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    #profile-form {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      width: 250px;
    }
    
    input {
      padding: 10px 15px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 10px 0 0 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(1, 58, 120, 0.3);
      min-width: 250px;
    }

    input:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }

    #saveBtn {
      min-width: 250px;
    }

    #fileInput {
      display: none;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h3>🎓 سامانه دانشگاه</h3>
    <div class="avatar-wrapper">
      <img id="avatarImg" onclick="toggleDropdown()">
      <div class="dropdown-menu" id="dropdownMenu">
        <a href="#" onclick="loadContent('settings')">⚙️ تنظیمات</a>
        <a href="#" onclick="logout()">🚪 خروج</a>
      </div>
    </div>
  </div>


  <div class="container">
    <div class="sidebar">
      <a href="#" class="menu-item" onclick="clearContents()" data-key="dashboard">📊 داشبورد</a>
      <a href="#" class="menu-item" data-key="courses">📚 دروس من</a>
      <a href="#" class="menu-item" data-key="grades">📝 نمرات</a>
      <a href="./food-reservation.html">🍔 رزرو غذا</a>
      <a href="#" class="menu-item" data-key="messages">📩 پیام‌ها</a>
      <a href="#" class="menu-item" data-key="settings">⚙️ تنظیمات</a>
      <a href="#" onclick="logout()">🚪 خروج</a>
    </div>

    <div class="main" id="mainContent">
      <div id="dashboard-content">
        <div class="card" id="welcomeCard">
          <h2>خوش آمدید، <span id="username"> دانشجوی </span> عزیز!</h2>
          <p>به سامانه مدیریت دانشگاه خوش آمدید. از منوی سمت راست برای دسترسی به بخش‌های مختلف استفاده کنید.</p>
        </div>

        <div class="card" id="announcementsCard">
          <h3>آخرین اطلاعیه‌ها</h3>
          <ul>
            <li>⏰ حذف و اضافه تا تاریخ ۱۰ خرداد تمدید شد.</li>
            <li>📢 شروع کلاس‌های ترم تابستان از ۲۰ تیر</li>
            <li>📌 نمرات نیم‌سال دوم تا پایان هفته اعلام می‌شود.</li>
          </ul>
        </div>
      </div>
      <div id="dynamic-content"></div>
      <div id="settings-content" style="display: none;">
        <div class="card">
          <h2>تنظیمات</h2>
          <p>تنظیمات حساب کاربری</p>
          <div class="setting-form">
            <div class="profile">
              <div class="profile-image-wrapper">
                <img src="" alt="Profile-picture" id="profile-image">
                <div class="add-icon" onclick="document.getElementById('fileInput').click()">+</div>
                <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
              </div>
              <div id="profile-form">
                <input type="text" id="new-username" placeholder="نام جدید را وارد کنید" />
                <input type="date" id="birth-date" />
                <button id="saveBtn" onclick="saveChanges()">ذخیره</button>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let username;

    const routes = {
      courses: "./dashboard/my-courses.html",
      grades: "./dashboard/grades.html",
      messages: "./dashboard/messages.html",
    };

    function loadContent(key) {
      const url = routes[key];

      const dashboard = document.getElementById('dashboard-content');
      const settings = document.getElementById('settings-content');
      const dynamic = document.getElementById('dynamic-content');

      if (key === "settings") {
        dashboard.style.display = 'none';
        settings.style.display = 'block';
        dynamic.style.display = 'none';
      } else {
        dashboard.style.display = 'block';
        settings.style.display = 'none';
        dynamic.style.display = 'block';
      }

      if (url) {
        fetch(url)
          .then(res => res.text())
          .then(html => {
            const target = key === "settings" ? settings : document.getElementById('dynamic-content');
            target.innerHTML = html;
          })
          .catch(err => {
            const target = key === "settings" ? settings : document.getElementById('dynamic-content');
            target.innerHTML = "<p>خطا در بارگذاری محتوا</p>";
            console.error(err);
          });
      }
    }


    document.querySelectorAll('.menu-item').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const key = link.getAttribute('data-key');
        loadContent(key);
      });
    });

    window.addEventListener("DOMContentLoaded", () => {
      loadContent("dashboard");
    });

    function clearContents() {
      document.getElementById('dynamic-content').innerHTML = ""
    }


    const API_BASE = 'http://localhost:3000/api';
    const userId = localStorage.getItem("userId");

    function getUserInfo() {
      fetch(`${API_BASE}/users/${userId}`)
        .then(response => {
          if (!response.ok) {
            console.log(response);
          };
          return response.json();
        })
        .then(user => {
          console.log('اطلاعات کاربر:', user);
          let username = user.username;
          const usernameEl = document.getElementById('username');
          if (usernameEl) usernameEl.textContent = username;

          const newUserNameEl = document.getElementById("new-username");
          newUserNameEl.value = username;

          const birthDate = new Date(user.birthDate);
          const birthDateEl = document.getElementById('birth-date');
          birthDateEl.value = birthDate.toISOString().split('T')[0];

          if (user.profileImage) {
            const avatarImg = document.getElementById("avatarImg");
            const profileImg = document.getElementById("profile-image");
            if (avatarImg) avatarImg.src = user.profileImage;
            if (profileImg) profileImg.src = user.profileImage;
          }
        })
        .catch(error => {
          console.error('مشکل در دریافت اطلاعات کاربر', error);
        });
    }
    

    

    function logout() {
      localStorage.clear();
      window.location.href = '/public/pages/login.html';
    }

    window.addEventListener('DOMContentLoaded', () => {
      getUserInfo();
      if (username) {
        document.getElementById('username').textContent = username;
      }
    });

    function toggleDropdown() {
      const menu = document.getElementById("dropdownMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    window.addEventListener("click", function (e) {
      const menu = document.getElementById("dropdownMenu");
      if (!e.target.closest(".avatar-wrapper")) {
        menu.style.display = "none";
      }
    });


    function previewImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profile-image').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }


    function saveChanges() {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        console.error("شناسه کاربر یافت نشد.");
        return;
      }

      const usernameInput = document.getElementById("new-username");
      const birthDateInput = document.getElementById("birth-date");
      const profileImage = document.getElementById("profile-image").src;

      const username = usernameInput.value.trim();
      const birthDate = birthDateInput.value;
      const defaultImage = window.location.origin + "/"; // یا آدرس پیش‌فرض اولیه img

      // ساختن داده‌ها فقط با فیلدهایی که پر شده‌اند
      const data = {};
      if (username) data.username = username;
      if (birthDate) data.birthDate = birthDate;
      if (profileImage && !profileImage.startsWith(defaultImage)) data.profileImage = profileImage;

      if (Object.keys(data).length === 0) {
        console.warn("هیچ فیلدی برای بروزرسانی وارد نشده است.");
        return;
      }
      fetch(`http://localhost:3000/api/users/${userId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      })
        .then(res => {
          if (!res.ok) throw new Error("خطا در بروزرسانی");
          return res.json();
        })
        .then(() => {
          console.log("اطلاعات با موفقیت به‌روزرسانی شد.");
          getUserInfo();
        })
        .catch(err => console.error("خطا:", err.message));
    }

    

  </script>
</body>
</html>
